<script type="text/javascript">
  RED.nodes.registerType('ads-over-mqtt-gvl', {
    category: 'function',
    color: '#a6bbcf',
    defaults: {
      name: { value: "" },
      connection: { type: "ads-over-mqtt-client-connection", required: true },
      gvlPrefixes: { value: "" },
      cycle: { value: false },
      interval: { value: 1 },
      unit: { value: "s" }
    },
    inputs: 1,
    outputs: 2,
    outputLabels: ["ADS SumRead Raw", "Invalid symbol version"],
    icon: 'bridge.png',
    label: function() {
      return this.name || 'ads gvl';
    },
    oneditprepare: function() {
      var existing = this.gvlPrefixes || (Array.isArray(this.gvls) ? this.gvls.join(';') : '');
      $("#node-input-gvlPrefixes").val(existing);
      function toggleCycle() {
        var show = $("#node-input-cycle").is(':checked');
        $(".ads-cycle").toggle(show);
      }
      $("#node-input-cycle").on('change', toggleCycle);
      toggleCycle();
    },
    oneditsave: function() {
      this.gvlPrefixes = $("#node-input-gvlPrefixes").val();
    }
  });
</script>

<script type="text/x-red" data-template-name="ads-over-mqtt-gvl">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name">
  </div>
  <div class="form-row">
    <label for="node-input-connection"><i class="fa fa-plug"></i> Connection</label>
    <input type="text" id="node-input-connection">
  </div>
  <div class="form-row">
    <label for="node-input-gvlPrefixes"><i class="fa fa-list"></i> GVL's Prefixe</label>
    <input type="text" id="node-input-gvlPrefixes">
  </div>
  <div class="form-row">
    <label>&nbsp;</label>
    <input type="checkbox" id="node-input-cycle" style="width:auto; margin-left:0;">
    <label for="node-input-cycle" style="width:auto;">Zyklus aktiv</label>
  </div>
  <div class="form-row ads-cycle">
    <label for="node-input-interval"><i class="fa fa-clock-o"></i> Intervall</label>
    <input type="number" id="node-input-interval" style="width:80px">&nbsp;
    <select id="node-input-unit" style="width:120px">
      <option value="ms">ms</option>
      <option value="s">s</option>
      <option value="min">min</option>
    </select>
  </div>
</script>

<script type="text/x-red" data-help-name="ads-over-mqtt-gvl">
  <p>Liest per Sum-Read alle Symbole, deren Name mit einem der konfigurierten GVL-Präfixe beginnt.</p>
  <p><b>Ausgänge</b>:</p>
  <ol>
    <li>Roh-Response des Sum-Reads als Buffer in <code>msg.payload</code>.</li>
    <li>String <code>"Invalid symbol version"</code>, wenn der ADS-Fehler 0x711 gemeldet wird.</li>
  </ol>
</script>
